'------------------------------------------------------------------------------
' <auto-generated>
'     This code was generated by a tool.
'     Runtime Version:2.0.50727.42
'
'     Changes to this file may cause incorrect behavior and will be lost if
'     the code is regenerated.
' </auto-generated>
'------------------------------------------------------------------------------

Option Strict Off
Option Explicit On

Imports Infoware.Datos
Imports WWTS.General.Reglas

#Region "Asistencia"
Public Class Asistencia

  Const _Procedimiento As String = "proc_Asistencia"

  Private mPeriodopago As PeriodoPago = Nothing

  Private mTipocontrato As TipoContrato = Nothing

  Private mContrato As Contrato = Nothing

  Private mPatrono As Patrono = Nothing

  Private mEmpleado As Empleado = Nothing

  Private mDias As DiaAsistenciaList = Nothing

  Private mAsistenciaDetList As AsistenciaDetList = Nothing

  Private mPardetSubCentroCosto As WWTSParametroDet = Nothing

  Private mSeleccionado As Boolean = False

  Public Sub New(ByVal _OperadorDatos As OperadorDatos, ByVal _EsNuevo As Boolean)
    MyBase.New()
    OperadorDatos = _OperadorDatos
    EsNuevo = _EsNuevo
  End Sub

  Public Sub New(ByVal _OperadorDatos As OperadorDatos, ByVal _contrato As Contrato, ByVal _Periodopago As PeriodoPago)
    If _OperadorDatos Is Nothing Then
      Throw New InvalidOperationException("El operador de datos es nulo")
    End If

    OperadorDatos = _OperadorDatos

    Me.Contrato = _contrato
    Me.Periodopago = _Periodopago
    EsNuevo = False
    If Not Me.RecargarContrato Then
      'Me.Asiste_TurnosRotativos = _contrato.Tipocontrato.TipCon_TurnosRotativos
      EsNuevo = True
      'Throw New Exception("El objeto no puede ser cargado")
    End If
  End Sub

  Public Sub New(ByVal _OperadorDatos As OperadorDatos, ByVal _Empleado As Empleado, ByVal _patrono As Patrono, ByVal _PeriodoPago As PeriodoPago)
    If _OperadorDatos Is Nothing Then
      Throw New InvalidOperationException("El operador de datos es nulo")
    End If

    OperadorDatos = _OperadorDatos

    Me.Empleado = _Empleado
    Me.Patrono = _patrono
    Me.Periodopago = _PeriodoPago
    EsNuevo = False
    If Not Me.RecargarEmpleado Then
      'Me.Asiste_TurnosRotativos = _contrato.Tipocontrato.TipCon_TurnosRotativos
      EsNuevo = True
      'Throw New Exception("El objeto no puede ser cargado")
    End If
  End Sub

  Public Sub New(ByVal _OperadorDatos As OperadorDatos, ByVal _contrato As Contrato)
    If _OperadorDatos Is Nothing Then
      Throw New InvalidOperationException("El operador de datos es nulo")
    End If

    OperadorDatos = _OperadorDatos

    Me.Contrato = _contrato
    EsNuevo = True
  End Sub

  Public Property Seleccionado() As Boolean
    Get
      Return mSeleccionado
    End Get
    Set(ByVal value As Boolean)
      mSeleccionado = value
    End Set
  End Property

  Public Property Patrono() As Patrono
    Get
      If mPatrono Is Nothing And Patron_Codigo <> 0 Then
        mPatrono = New Patrono(OperadorDatos, Patron_Codigo)
      End If
      Return mPatrono
    End Get
    Set(ByVal Value As Patrono)
      If Value Is Nothing Then
        Throw New Exception("No se puede enlazar patrono")
      End If
      Patron_Codigo = Value.Patron_Codigo
      mPatrono = Value
    End Set
  End Property

  'Periodopago
  Public Overridable Property Periodopago() As PeriodoPago
    Get
      If Me.mPeriodopago Is Nothing AndAlso Pardet_PeriodoPago > 0 Then
        Me.mPeriodopago = New PeriodoPago(OperadorDatos, PerPag_FechaDesde, Parame_PeriodoPago, Pardet_PeriodoPago)
      End If
      Return Me.mPeriodopago

    End Get
    Set(ByVal value As PeriodoPago)
      Me.mPeriodopago = value
      PerPag_FechaDesde = value.PerPag_FechaDesde
      Pardet_PeriodoPago = value.Pardet_PeriodoPago
      Parame_PeriodoPago = value.Parame_PeriodoPago
    End Set
  End Property

  'Periodopago
  Public Overridable Property PardetSubCentroCosto() As WWTSParametroDet
    Get
      If Me.mPardetSubCentroCosto Is Nothing AndAlso Pardet_SubCentroCosto > 0 Then
        Me.mPardetSubCentroCosto = New WWTSParametroDet(OperadorDatos, Parame_SubCentroCosto, Pardet_SubCentroCosto)
      End If
      Return Me.mPardetSubCentroCosto

    End Get
    Set(ByVal value As WWTSParametroDet)
      Me.mPardetSubCentroCosto = value
      Pardet_SubCentroCosto = value.Pardet_Secuencia
      Parame_SubCentroCosto = value.Parame_Codigo
    End Set
  End Property

  Public Property Contrato() As Contrato
    Get
      If mContrato Is Nothing And Patron_Codigo <> 0 And Entida_Codigo <> 0 And Contra_Secuencia > 0 Then
        mContrato = New Contrato(Me.OperadorDatos, Entida_Codigo, Patron_Codigo, Contra_Secuencia)
      End If
      Return mContrato
    End Get
    Set(ByVal Value As Contrato)
      Me.mContrato = Value
      If Value Is Nothing Then
        Me.Patron_Codigo = 0
        'Me.Empleado = Nothing
        Me.Contra_Secuencia = -1
      Else
        Me.Patron_Codigo = Value.Patron_Codigo
        Me.Empleado = Value.Empleado
        Me.Contra_Secuencia = Value.Contra_Secuencia
        If Me.EsNuevo Then
          Me.Asiste_TurnosRotativos = Me.Contrato.Tipocontrato.TipCon_TurnosRotativos
        End If
      End If
    End Set
  End Property

  'Tipocontrato
  Public Overridable Property Tipocontrato() As TipoContrato
    Get
      If Me.mTipocontrato Is Nothing AndAlso Contrato IsNot Nothing AndAlso Contrato.TipCon_Codigo > 0 Then
        Me.mTipocontrato = New TipoContrato(OperadorDatos, Contrato.Patron_Codigo, Contrato.TipCon_Codigo)
      End If
      Return Me.mTipocontrato
    End Get
    Set(ByVal value As TipoContrato)
      Me.mTipocontrato = value
      Contrato.TipCon_Codigo = value.TipCon_Codigo
    End Set
  End Property

  Public Property Empleado() As Empleado
    Get
      If mEmpleado Is Nothing AndAlso Entida_Codigo <> 0 Then
        mEmpleado = New Empleado(OperadorDatos, Entida_Codigo)
      End If
      Return mEmpleado
    End Get
    Set(ByVal value As Empleado)
      mEmpleado = value
      Entida_Codigo = value.Entida_Codigo
    End Set
  End Property

  Public ReadOnly Property EmpleadoString() As String
    Get
      If Empleado Is Nothing Then
        Return String.Empty
      Else
        Return Empleado.NombreCompleto
      End If
    End Get
  End Property

  Public ReadOnly Property CodigoEmpleado() As String
    Get
      If Empleado Is Nothing Then
        Return String.Empty
      Else
        Return Empleado.CodigoEmpleado
      End If
    End Get
  End Property

#Region "Totales"
  Public ReadOnly Property Prestado() As Decimal
    Get
      Dim _prestado As Decimal = 0
      Dim _prestamos As New PrestamoList
      _prestamos = PrestamoList.ObtenerLista(OperadorDatos, Me.Contrato, PrestamoList.enumReportePrestamo.Aprobados, Periodopago.PerPag_FechaDesde, Periodopago.PerPag_FechaHasta)
      For Each _prestamo As Prestamo In _prestamos
        _prestado += _prestamo.Presta_ValorAprobado
      Next
      Return _prestado
    End Get
  End Property

  'Public ReadOnly Property Total_ingresos() As Double
  '  Get
  '    Return Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b - Asiste_SubMatEnf + Asiste_ICS + Asiste_AdicionalP + Asiste_Libre + Asiste_OtrosIngresos + Asiste_OtrosIngresosnoAp
  '  End Get
  'End Property

  'Public ReadOnly Property Total_beneficios() As Double
  '  Get
  '    Return Asiste_D3Pag + Asiste_D4Pag + Asiste_VacPag
  '  End Get
  'End Property

  'Public ReadOnly Property Total_egresos() As Double
  '  Get
  '    Return Asiste_IESS + Asiste_Prestamo + Asiste_PrestamoQuirog + Asiste_ImpuestoRenta + Asiste_Multa + Asiste_Anticipos + Asiste_Faltantes + Asiste_DesctoFaltas
  '  End Get
  'End Property

  'Public ReadOnly Property Total_periodo() As Double
  '  Get
  '    Return Total_ingresos - Total_egresos + Asiste_TranspP + Total_beneficios
  '  End Get
  'End Property
#End Region

#Region "Dias"
  Public Property Dias(Optional ByVal _RevisarAvisos As Boolean = False) As DiaAsistenciaList
    Get
      If mDias Is Nothing Or _RevisarAvisos Then
        'Dim mdias As DiaAsistenciaList
        If Periodopago Is Nothing Then
          Throw New Exception("Debe seleccionar un periodo")
        End If
        mDias = New DiaAsistenciaList
        Dim difdays As Integer = mPeriodopago.IntervaloDias()

        'Dim _avisos As PermisoList = New PermisoList
        Dim _avisos As LicenciaList = New LicenciaList
        If _RevisarAvisos And mContrato IsNot Nothing Then
          '_avisos = PermisoList.ObtenerLista(OperadorDatos, mContrato, mPeriodopago.PerPag_FechaDesdeMarcacion, mPeriodopago.PerPag_FechaHastaMarcacion)
          _avisos = LicenciaList.ObtenerLista(OperadorDatos, mContrato, mPeriodopago.PerPag_FechaDesde, mPeriodopago.PerPag_FechaHasta)
        End If

        For t As Integer = 1 To difdays
          Dim _dia As DiaAsistencia
          Dim _fecha As Date = mPeriodopago.PerPag_FechaDesde.AddDays(t - 1)
          _dia = New DiaAsistencia(OperadorDatos, Me, _fecha)
          If _RevisarAvisos Then
            Dim _estaenfermo As Boolean = False
            Dim _estavacaciones As Boolean = False
            Dim _estamaternidad As Boolean = False
            'For Each _aviso As Permiso In _avisos
            For Each _aviso As Licencia In _avisos
              'If _fecha >= _aviso.Permis_FechaDesde And _fecha <= _aviso.Permis_FechaHasta Then
              '  If _aviso.Pardet_TipoPermisoEnum = Enumerados.enumTipoPermiso.Vacaciones Then
              '    _estavacaciones = True
              '  Else
              '    _estaenfermo = True
              '  End If
              'End If
              If _fecha >= _aviso.Licenc_Desde And _fecha <= _aviso.Licenc_Hasta Then
                If _aviso.Pardet_LicenciaEnum = Enumerados.enumTipoPermiso.Vacaciones Then
                  _estavacaciones = True
                ElseIf _aviso.Pardet_LicenciaEnum = Enumerados.enumTipoPermiso.Maternidad Then
                  _estamaternidad = True
                Else
                  _estaenfermo = True
                End If
              End If
            Next
            If _estaenfermo Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Enfermedad_Maternidad
            End If
            If _estavacaciones Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Vacaciones
            End If
            If _estamaternidad Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Maternidad
            End If
          End If
          'If mNuevo And Not Me.Contrato Is Nothing Then
          '  If _dia.DiaAsi_fecha.CompareTo(Me.Contrato.Con_desde) < 0 Then
          '    '_dia.DiaAsi_estado = Enumerados.EnumEstadoModeloLabor.NoRegistra
          '    '_dia.DiaAsi_asistencia = False
          '    '_dia.DiaAsi_jornada = 0
          '    '_dia.DiaAsi_sobret = 0
          '    _dia = Nothing
          '  End If
          'End If
          mDias.Add(_dia)
        Next
      End If
      Return mDias
    End Get
    Set(ByVal value As DiaAsistenciaList)
      mDias = value
    End Set
  End Property
#End Region

#Region "DiasMarcacion"
  Public Property DiasMarcacion(Optional ByVal _RevisarAvisos As Boolean = False) As DiaAsistenciaList
    Get
      If mDias Is Nothing Or _RevisarAvisos Then
        'Dim mdias As DiaAsistenciaList
        If Periodopago Is Nothing Then
          Throw New Exception("Debe seleccionar un periodo")
        End If
        mDias = New DiaAsistenciaList
        Dim difdays As Integer = mPeriodopago.IntervaloDiasMarcacion()

        'Dim _avisos As PermisoList = New PermisoList
        Dim _avisos As LicenciaList = New LicenciaList
        If _RevisarAvisos And mContrato IsNot Nothing Then
          '_avisos = PermisoList.ObtenerLista(OperadorDatos, mContrato, mPeriodopago.PerPag_FechaDesdeMarcacion, mPeriodopago.PerPag_FechaHastaMarcacion)
          _avisos = LicenciaList.ObtenerLista(OperadorDatos, mContrato, mPeriodopago.PerPag_FechaDesde, mPeriodopago.PerPag_FechaHasta)
        End If

        For t As Integer = 1 To difdays
          Dim _dia As DiaAsistencia
          Dim _fecha As Date = mPeriodopago.PerPag_FechaDesdeMarcacion.AddDays(t - 1)
          _dia = New DiaAsistencia(OperadorDatos, Me, _fecha)
          If _RevisarAvisos Then
            Dim _estaenfermo As Boolean = False
            Dim _estavacaciones As Boolean = False
            Dim _estamaternidad As Boolean = False
            'For Each _aviso As Permiso In _avisos
            For Each _aviso As Licencia In _avisos
              'If _fecha >= _aviso.Permis_FechaDesde And _fecha <= _aviso.Permis_FechaHasta Then
              '  If _aviso.Pardet_TipoPermisoEnum = Enumerados.enumTipoPermiso.Vacaciones Then
              '    _estavacaciones = True
              '  Else
              '    _estaenfermo = True
              '  End If
              'End If
              If _fecha >= _aviso.Licenc_Desde And _fecha <= _aviso.Licenc_Hasta Then
                If _aviso.Pardet_LicenciaEnum = Enumerados.enumTipoPermiso.Vacaciones Then
                  _estavacaciones = True
                ElseIf _aviso.Pardet_LicenciaEnum = Enumerados.enumTipoPermiso.Maternidad Then
                  _estamaternidad = True
                Else
                  _estaenfermo = True
                End If
              End If
            Next
            If _estaenfermo Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Enfermedad_Maternidad
            End If
            If _estavacaciones Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Vacaciones
            End If
            If _estamaternidad Then
              _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Maternidad
            End If
          End If
          'If mNuevo And Not Me.Contrato Is Nothing Then
          '  If _dia.DiaAsi_fecha.CompareTo(Me.Contrato.Con_desde) < 0 Then
          '    '_dia.DiaAsi_estado = Enumerados.EnumEstadoModeloLabor.NoRegistra
          '    '_dia.DiaAsi_asistencia = False
          '    '_dia.DiaAsi_jornada = 0
          '    '_dia.DiaAsi_sobret = 0
          '    _dia = Nothing
          '  End If
          'End If
          mDias.Add(_dia)
        Next
      End If
      Return mDias
    End Get
    Set(ByVal value As DiaAsistenciaList)
      mDias = value
    End Set
  End Property
#End Region

#Region "Proporcionales"
  'Public ReadOnly Property DecimoTerceroProporcional() As Decimal
  '  Get
  '    Return (mAsiste_S0 + mAsiste_S25 + mAsiste_S50 + mAsiste_S100 + mAsiste_S100b + mAsiste_ICS + mAsiste_AdicionalP + mAsiste_Libre + Asiste_OtrosIngresos) / 12
  '  End Get
  'End Property

  'Public ReadOnly Property DecimoCuartoProporcional() As Decimal
  '  Get
  '    Dim _config As New ConfigRoles(OperadorDatos, Contrato.Patrono.Pais, False)
  '    Return _config.Cnfrol_salariomv / 360 * (Asiste_Dias + Asiste_DiasIntegrales + Asiste_DiasVac)
  '  End Get
  'End Property

  'Public ReadOnly Property VacacionesProporcional() As Decimal
  '  Get
  '    Return (mAsiste_S0 + mAsiste_S25 + mAsiste_S50 + mAsiste_S100 + mAsiste_S100b + mAsiste_ICS + mAsiste_AdicionalP + mAsiste_Libre + Asiste_OtrosIngresos) / 24
  '  End Get
  'End Property
#End Region

#Region "Métodos"
  Public Sub Calcular(ByVal _solocalculo As Boolean, Optional ByVal _recalcularhoras As Boolean = False)
    Select Case TipoContrato.Pardet_TipoContratoEnum
      Case Enumerados.enumTipoContrato.Fijo
        Select Case TipoContrato.Pardet_PeriodoPagoEnum
          Case Enumerados.enumPeriodoPago.Quincenal
            Calcular_Fijo_Quincenal(_solocalculo)
          Case Else
            Throw New Exception("No existe cálculo para este tipo de contrato")
        End Select
      Case Enumerados.enumTipoContrato.PorHoras ', Enumerados.enumTipoContrato.Destajo
        Throw New Exception("No existe cálculo para este tipo de contrato")
      Case Enumerados.enumTipoContrato.Temporada
        Select Case Tipocontrato.Pardet_PeriodoPagoEnum
          Case Enumerados.enumPeriodoPago.Quincenal
            Calcular_Fijo_Quincenal(_solocalculo)
            'Calcular_Temporada_Quincenal(_solocalculo)
          Case Else
            Throw New Exception("No existe cálculo para este tipo de contrato")
        End Select
    End Select
  End Sub


  Public Property AsistenciaDetList() As AsistenciaDetList
    Get
      mAsistenciaDetList = New AsistenciaDetList()
      If Not mDias Is Nothing Then
        If Periodopago Is Nothing Then
          Throw New Exception("Debe seleccionar un periodo")
        End If
        'mDias = New DiaAsistenciaList
        Dim difdays As Integer = mPeriodopago.IntervaloDias()

        Dim _licencias As LicenciaList = New LicenciaList
        If mContrato IsNot Nothing Then
          _licencias = LicenciaList.ObtenerLista(OperadorDatos, mContrato, mPeriodopago.PerPag_FechaDesde, mPeriodopago.PerPag_FechaHasta)
        End If

        Dim _pardetlist As WWTSParametroDetList = WWTSParametroDetList.ObtenerLista(OperadorDatos, Enumerados.EnumParametros.Licencia)

        'crea asistenciadetlist con parametrodetlist
        Dim cont As Integer = 1
        For Each _pardet As WWTSParametroDet In _pardetlist
          Dim _asisdet As AsistenciaDet = New AsistenciaDet(OperadorDatos, True)
          _asisdet.Asistencia = Me
          _asisdet.AsiDet_Secuencia = cont
          _asisdet.PardetLicencia = _pardet
          _asisdet.EsNuevo = True
          mAsistenciaDetList.Add(_asisdet)
          cont += 1
        Next

        'Dim vacaciones As AsistenciaDetList

        'For t As Integer = 1 To difdays
        '  Dim _fecha As Date = mPeriodopago.PerPag_FechaDesde.AddDays(t - 1)
        '  For Each _asidet As AsistenciaDet In mAsistenciaDetList
        '    For Each _licencia As Licencia In _licencias
        '      If _fecha >= _licencia.Licenc_Desde And _fecha <= _licencia.Licenc_Hasta Then
        '        If _licencia.Pardet_Licencia = _asidet.Pardet_Licencia Then
        '          _asidet.AsiDet_LicenciaDias += 1
        '          If _asidet.Pardet_Licencia = Enumerados.enumLicencia.Vacaciones Then
        '            vacaciones = AsistenciaDetList.ObtenerVacacion(OperadorDatos, Me, mPeriodopago.PerPag_FechaHasta, _licencia.BenSoc_Secuencia)
        '            If vacaciones.Count > 0 Then
        '              _asidet.AsiDet_LicenciaDias = vacaciones.Item(0).AsiDet_LicenciaDias
        '            Else
        '              _asidet.AsiDet_LicenciaDias = 0
        '            End If
        '          End If
        '        End If
        '      End If
        '    Next
        '  Next
        'Next

        For Each _asidet As AsistenciaDet In mAsistenciaDetList
          Dim _dias As DiaAsistenciaList = Me.Dias()
          For Each diaasis As DiaAsistencia In _dias
            If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Enfermedad_Maternidad Then
              If _asidet.Pardet_Licencia = Enumerados.enumLicencia.Enfermedad Then
                _asidet.AsiDet_LicenciaDias += 1
              End If
            ElseIf diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Maternidad Then
              If _asidet.Pardet_Licencia = Enumerados.enumLicencia.Maternidad Then
                _asidet.AsiDet_LicenciaDias += 1
              End If
            ElseIf diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.SinSueldo Then
              If _asidet.Pardet_Licencia = Enumerados.enumLicencia.SinSueldo Then
                _asidet.AsiDet_LicenciaDias += 1
              End If
            ElseIf diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Vacaciones Then
              If _asidet.Pardet_Licencia = Enumerados.enumLicencia.Vacaciones Then
                _asidet.AsiDet_LicenciaDias += 1
                'For Each _licencia As Licencia In _licencias
                '  'If _asidet.Pardet_Licencia = Enumerados.enumLicencia.Vacaciones Then
                '  vacaciones = AsistenciaDetList.ObtenerVacacion(OperadorDatos, Me, mPeriodopago.PerPag_FechaHasta, _licencia.BenSoc_Secuencia)
                '  If vacaciones.Count > 0 Then
                '    _asidet.AsiDet_LicenciaDias = vacaciones.Item(0).AsiDet_LicenciaDias
                '  Else
                '    _asidet.AsiDet_LicenciaDias = 0
                '  End If
                '  'End If
                'Next
              End If
            End If
          Next
        Next


      End If
      Return mAsistenciaDetList
    End Get
    Set(ByVal value As AsistenciaDetList)
      mAsistenciaDetList = value
    End Set
  End Property


  Private Sub Calcular_Fijo_Mensual(ByVal _solocalculo As Boolean, Optional ByVal _recalcularhoras As Boolean = False)
    Dim _faltastotales As Integer = 0
    Dim _faltasdiasintegrales As Integer = 0
    Dim _diaslibres As Integer = 0
    Dim _diaspermiso As Integer = 0
    Dim _diasmaternidad As Integer = 0
    Dim _diasnoreg As Integer = 0

    'contar faltas y diaslibres
    For Each _dia As DiaAsistencia In Dias
      Select Case _dia.Pardet_EstadoDiaEnum
        Case Enumerados.enumEstadoModeloLabor.DiaLibre
          If Me.Asiste_TurnosRotativos Then
            _diaslibres += 1
          End If
        Case Enumerados.enumEstadoModeloLabor.Permiso
          _diaspermiso += 1
        Case Enumerados.enumEstadoModeloLabor.Enfermedad_Maternidad
          _diasmaternidad += 1
        Case Enumerados.enumEstadoModeloLabor.NoRegistra
          _diasnoreg += 1
      End Select

      Select Case _dia.DiaAsi_Fecha.DayOfWeek
        Case DayOfWeek.Sunday, DayOfWeek.Saturday
          If Not Me.Asiste_TurnosRotativos Then
            _diaslibres += 1
          End If
      End Select
    Next

    If _recalcularhoras Then
      'distribuir horas
      'Const tothsemana As Integer = 40
      'Dim conthsemana As Integer = 0
      Dim contdia As Integer = 0
      Dim contdiames As Integer = 0
      Dim contsemanas As Integer = 1
      Dim _semana(6) As DiaAsistencia
      For Each _diames As DiaAsistencia In Dias
        contdiames += 1

        If Me.Asiste_TurnosRotativos Then
          If contdia = 0 Then 'limpiar semana
            For t As Integer = 0 To 6
              _semana(t) = Nothing
            Next
          End If

          'APLICAR REGLA SOLO 12 HORAS AL DIA
          '02/06/10 LOS DIAS DOMINGOS HASTA 14 HORAS
          Dim hmax As Integer = 12
          If _diames.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
            hmax = 14
          End If

          While _diames.HorasTrabAux > hmax
            ' si trabajo más de 12 horas entonces comenzar a restar horas desde el 100% al 0%
            If _diames.DiaAsi_Sobret100baux > 0 Then
              _diames.DiaAsi_Sobret100baux -= 1
            ElseIf _diames.DiaAsi_Sobret100aux > 0 Then
              _diames.DiaAsi_Sobret100aux -= 1
            ElseIf _diames.DiaAsi_Sobret50aux > 0 Then
              _diames.DiaAsi_Sobret50aux -= 1
            ElseIf _diames.DiaAsi_Sobret25aux > 0 Then
              _diames.DiaAsi_Sobret25aux -= 1
            ElseIf _diames.DiaAsi_Jornadaaux > 0 Then
              _diames.DiaAsi_Jornadaaux -= 1
            End If
          End While

          _semana(_diames.DiaAsi_Fecha.DayOfWeek) = _diames

          contdia += 1
          If contdia >= 7 Or contdiames >= Dias.Count Then
            'calcular semana desde matriz _semana
            Dim _faltasensemana As Integer = 0

            Dim _horasnormsemana As Integer = 0
            Dim _horastrabsemana As Integer = 0
            For t As Integer = 1 To 7
              Dim _dia As DiaAsistencia = _semana(IIf(t = 7, 0, t))
              If _dia IsNot Nothing Then
                _horasnormsemana += _dia.DiaAsi_Jornadaaux + _dia.DiaAsi_Sobret25aux
                _horastrabsemana += _dia.HorasTrabAux

                'si falto entonces acumular en _faltasensemana
                Select Case _dia.Pardet_EstadoDiaEnum
                  Case Enumerados.enumEstadoModeloLabor.Normal
                    If Me.Asiste_TurnosRotativos Then
                      If _dia.EsNuevo Or _recalcularhoras Then
                        If _dia.HorasTrabAux = 0 Then
                          _faltasensemana += 1
                        End If
                      Else
                        If _dia.HorasTrab = 0 Then
                          _faltasensemana += 1
                        End If
                      End If
                    Else
                      If Not (_dia.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or _dia.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday) Then
                        If _dia.EsNuevo Then
                          If _dia.HorasTrabAux = 0 Then
                            _faltasensemana += 1
                          End If
                        Else
                          If _dia.HorasTrab = 0 Then
                            _faltasensemana += 1
                          End If
                        End If
                      End If
                    End If
                End Select
              End If
            Next

            If _faltasensemana = 1 Then
              _faltasdiasintegrales += 1
              _faltastotales += 1
            ElseIf _faltasensemana > 1 Then
              _faltasdiasintegrales += 2
              _faltastotales += 2
            End If
            _faltastotales += _faltasensemana


            'restar de una vez las horas >40 de los dias libres
            If _horasnormsemana > 40 Then
              For t As Integer = 7 To 1 Step -1
                Dim _dia As DiaAsistencia = _semana(IIf(t = 7, 0, t))
                If _dia IsNot Nothing AndAlso _recalcularhoras AndAlso contdia = 7 Then
                  If _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
                    _horasnormsemana -= _dia.DiaAsi_Sobret100baux
                    If _horastrabsemana > 40 Then
                      Dim _horasmenos As Integer
                      _horasmenos = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100aux -= _horasmenos
                      _dia.DiaAsi_Sobret100baux += _horasmenos
                      '_horasnormsemana -= _horasmenos
                    End If
                    If _horastrabsemana > 40 Then
                      Dim _horasmenos As Integer
                      _horasmenos = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret50aux -= _horasmenos
                      _dia.DiaAsi_Sobret100baux += _horasmenos
                      '_horasnormsemana -= _horasmenos
                    End If
                    If _horasnormsemana > 40 Then
                      Dim _horasmenos As Integer
                      _horasmenos = IIf(_dia.DiaAsi_Sobret25aux <= _horasnormsemana - 40, _dia.DiaAsi_Sobret25aux, _horasnormsemana - 40)
                      _dia.DiaAsi_Sobret25aux -= _horasmenos
                      _dia.DiaAsi_Sobret100baux += _horasmenos
                      _horasnormsemana -= _horasmenos
                    End If
                    If _horasnormsemana > 40 Then
                      Dim _horasmenos As Integer
                      _horasmenos = IIf(_dia.DiaAsi_Jornadaaux <= _horasnormsemana - 40, _dia.DiaAsi_Jornadaaux, _horasnormsemana - 40)
                      _dia.DiaAsi_Jornadaaux -= _horasmenos
                      _dia.DiaAsi_Sobret100baux += _horasmenos
                      _horasnormsemana -= _horasmenos
                    End If
                  End If
                End If
              Next
            End If

            'restar mas de 40 horas del resto de la semana
            For t As Integer = 7 To 1 Step -1
              Dim _dia As DiaAsistencia = _semana(IIf(t = 7, 0, t))

              If _dia IsNot Nothing Then
                _dia.Semana = contsemanas
                If _recalcularhoras Then
                  If contdia < 7 Then 'semana corta
                    If _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Or _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then
                      _dia.DiaAsi_Jornada = 0
                      _dia.DiaAsi_Sobret25 = 0
                      _dia.DiaAsi_Sobret50 = 0
                      _dia.DiaAsi_Sobret100 = 0
                      _dia.DiaAsi_Sobret100b = _dia.HorasTrabAux
                    Else
                      _dia.DiaAsi_Jornada = _dia.DiaAsi_Jornadaaux
                      _dia.DiaAsi_Sobret25 = _dia.DiaAsi_Sobret25aux
                      _dia.DiaAsi_Sobret50 = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret100 = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100b = _dia.DiaAsi_Sobret100baux
                    End If
                  Else 'semana completa
                    If _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
                      _dia.DiaAsi_Jornada = _dia.DiaAsi_Jornadaaux
                      _dia.DiaAsi_Sobret25 = _dia.DiaAsi_Sobret25aux
                      _dia.DiaAsi_Sobret50 = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret100 = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100b = _dia.DiaAsi_Sobret100baux
                    ElseIf _dia.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then '_horastrabsemana >= 40 AndAlso
                      _dia.DiaAsi_Jornada = 0
                      _dia.DiaAsi_Sobret25 = 0
                      _dia.DiaAsi_Sobret50 = 0
                      _dia.DiaAsi_Sobret100 = 0
                      _dia.DiaAsi_Sobret100b = _dia.HorasTrabAux

                    ElseIf _horasnormsemana > 40 Then

                      If _horasnormsemana > 40 Then
                        Dim _horasmenos As Integer
                        _horasmenos = IIf(_dia.DiaAsi_Jornadaaux <= _horasnormsemana - 40, _dia.DiaAsi_Jornadaaux, _horasnormsemana - 40)
                        _dia.DiaAsi_Jornadaaux -= _horasmenos
                        If _dia.DiaAsistenciaWeb Is Nothing Then
                          MsgBox("NO existe Dia Asistencia Web " + _dia.DiaAsi_Fecha.ToShortDateString + " " + _dia.Asistencia.Contrato.NombreString)
                        End If
                        If _dia.DiaAsistenciaWeb.Hora_Entrada.Hour >= 6 And _dia.DiaAsistenciaWeb.Hora_Entrada.Hour <= 16 And (_dia.DiaAsistenciaWeb.Hora_Salida.Hour <= 24 Or _dia.DiaAsistenciaWeb.Hora_Salida.Hour = 0) Then
                          _dia.DiaAsi_Sobret50aux += _horasmenos
                        Else
                          _dia.DiaAsi_Sobret100aux += _horasmenos
                        End If
                        _horasnormsemana -= _horasmenos
                      End If

                      If _horasnormsemana > 40 Then
                        Dim _horasmenos As Integer
                        _horasmenos = IIf(_dia.DiaAsi_Sobret25aux <= _horasnormsemana - 40, _dia.DiaAsi_Sobret25aux, _horasnormsemana - 40)
                        _dia.DiaAsi_Sobret25aux -= _horasmenos
                        If _dia.DiaAsistenciaWeb.Hora_Entrada.Hour >= 6 And _dia.DiaAsistenciaWeb.Hora_Entrada.Hour <= 16 And (_dia.DiaAsistenciaWeb.Hora_Salida.Hour <= 24 Or _dia.DiaAsistenciaWeb.Hora_Salida.Hour = 0) Then
                          _dia.DiaAsi_Sobret50aux += _horasmenos
                        Else
                          _dia.DiaAsi_Sobret100aux += _horasmenos
                        End If
                        _horasnormsemana -= _horasmenos
                      End If

                      _dia.DiaAsi_Jornada = _dia.DiaAsi_Jornadaaux
                      _dia.DiaAsi_Sobret25 = _dia.DiaAsi_Sobret25aux
                      _dia.DiaAsi_Sobret50 = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret100 = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100b = _dia.DiaAsi_Sobret100baux
                    ElseIf _horasnormsemana < 40 Then

                      If _horasnormsemana < 40 Then
                        Dim _horasmenos As Integer
                        _horasmenos = IIf(_dia.DiaAsi_Sobret100baux <= 40 - _horasnormsemana, _dia.DiaAsi_Sobret100baux, 40 - _horasnormsemana)
                        _dia.DiaAsi_Sobret100baux -= _horasmenos
                        _dia.DiaAsi_Jornadaaux += _horasmenos
                        _horasnormsemana += _horasmenos
                      End If

                      If _horasnormsemana < 40 Then
                        Dim _horasmenos As Integer
                        _horasmenos = IIf(_dia.DiaAsi_Sobret100aux <= 40 - _horasnormsemana, _dia.DiaAsi_Sobret100aux, 40 - _horasnormsemana)
                        _dia.DiaAsi_Sobret100aux -= _horasmenos
                        _dia.DiaAsi_Jornadaaux += _horasmenos
                        _horasnormsemana += _horasmenos
                      End If

                      If _horasnormsemana < 40 Then
                        Dim _horasmenos As Integer
                        _horasmenos = IIf(_dia.DiaAsi_Sobret50aux <= 40 - _horasnormsemana, _dia.DiaAsi_Sobret50aux, 40 - _horasnormsemana)
                        _dia.DiaAsi_Sobret50aux -= _horasmenos
                        _dia.DiaAsi_Jornadaaux += _horasmenos
                        _horasnormsemana += _horasmenos
                      End If

                      _dia.DiaAsi_Jornada = _dia.DiaAsi_Jornadaaux
                      _dia.DiaAsi_Sobret25 = _dia.DiaAsi_Sobret25aux
                      _dia.DiaAsi_Sobret50 = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret100 = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100b = _dia.DiaAsi_Sobret100baux

                    Else
                      _dia.DiaAsi_Jornada = _dia.DiaAsi_Jornadaaux
                      _dia.DiaAsi_Sobret25 = _dia.DiaAsi_Sobret25aux
                      _dia.DiaAsi_Sobret50 = _dia.DiaAsi_Sobret50aux
                      _dia.DiaAsi_Sobret100 = _dia.DiaAsi_Sobret100aux
                      _dia.DiaAsi_Sobret100b = _dia.DiaAsi_Sobret100baux
                    End If
                  End If
                End If
              End If
            Next

            contdia = 0
            contsemanas += 1
          End If
        Else ' no es turno rotativo
          If _diames.EsNuevo Or _recalcularhoras Then
            _diames.DiaAsi_Jornada = _diames.DiaAsi_Jornadaaux
            _diames.DiaAsi_Sobret25 = _diames.DiaAsi_Sobret25aux
            _diames.DiaAsi_Sobret50 = _diames.DiaAsi_Sobret50aux
            _diames.DiaAsi_Sobret100 = _diames.DiaAsi_Sobret100aux
            _diames.DiaAsi_Sobret100b = _diames.DiaAsi_Sobret100baux
          End If
        End If
      Next
    End If

    Dim prestpagado As Double = 0.0
    Dim anticipos As Double = 0.0
    Dim faltantes As Double = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Double = 0.0
    Dim diasvac As Integer = 0
    Dim smatenf As Double = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    'Dim s0 As Double = 0.0
    Dim s25 As Double = 0.0
    Dim s50 As Double = 0.0
    Dim s100 As Double = 0.0
    Dim s100b As Double = 0.0
    Dim adic As Double = 0.0
    Dim libre As Double = 0.0
    Dim transp As Double = 0.0
    Dim cs As Double = 0.0
    'Dim iess As Double = 0.0

    For Each _dia As DiaAsistencia In Dias
      'diario += _dia.DiaAsi_diario
      diasint += _dia.DiaAsi_integrales
      diasvac += _dia.DiaAsi_vacaciones
      'smatenf += _dia.DiaAsi_valorsubmatenf
      h0 += _dia.DiaAsi_Jornada
      h25 += _dia.DiaAsi_H25
      h50 += _dia.DiaAsi_H50
      h100 += _dia.DiaAsi_H100
      h100b += _dia.DiaAsi_H100b
      's0 += _dia.DiaAsi_ValorH0 + _dia.DiaAsi_ValorIntegral
      's25 += _dia.DiaAsi_ValorH25
      's50 += _dia.DiaAsi_ValorH50
      's100 += _dia.DiaAsi_ValorH100
      's100b += _dia.DiaAsi_ValorH100b
      'adic += _dia.DiaAsi_Valoradicional
      'libre += _dia.DiaAsi_ValorHLibre
      'transp += _dia.DiaAsi_Valortransporte
      'cs += _dia.DiaAsi_ValorCompSal
      'iess += _dia.DiaAsi_ValorIESS
    Next

    If _recalcularhoras Then
      'Asiste_Dias = 30 - diasvac - _faltas - _diasintegmenos - _diasnoreg '- diasint- _diaspermiso
      'If _faltas >= 1 Then
      '  _faltas = 2
      'End If
      If diasvac >= 8 Then
        diasvac = 15
      Else
        diasvac = 0
      End If
    Else
      _faltastotales = Asiste_Faltas '_faltas = Asiste_Faltas
      'diasvac = Asiste_DiasVac
      _diasnoreg = Asiste_DiasInactivos
    End If

    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    faltantes = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Faltantes)
    Asiste_Dias = 30 - diasvac - _diasnoreg - _faltastotales '_faltas '- diasint - diasvac - _faltas - _diasnoreg - _diasintegmenos 'diario- _diaspermiso
    Asiste_DiasInactivos = _diasnoreg
    Asiste_Faltas = _faltastotales '_faltas
    'Asiste_DesctoFaltas = Asiste_SueldoBase / 30 * (_faltas)
    Asiste_DiasIntegrales = diasint
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b

    Asiste_FaltasIntegrales = _faltasdiasintegrales

    'Asiste_SubMatEnf = (Asiste_SueldoBase / 30 * _diasmaternidad) * (100 - Asiste_PorcSubMatEnf) / 100
    'Asiste_ICS = cs
    'Asiste_S0 = Asiste_SueldoBase / 30 * (30 - diasvac - _diasnoreg) ' - _faltas - _diasnoreg - _diasintegmenos)
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_AdicionalP = adic
    'Asiste_Libre = 0 'libre
    'Asiste_IESS = 0
    'If Contrato IsNot Nothing AndAlso Me.Contrato.Contra_afiliess Then
    '  Asiste_IESS = (Asiste_S0 + adic + Asiste_Libre + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b - Asiste_SubMatEnf + Asiste_OtrosIngresos) * Asiste_PorcentajeIESS / 100 'DiaAsi_ValorIntegral
    'End If
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_Faltantes = faltantes
    'Asiste_PrestamoQuirog = Contrato.Empleado.Emplea_DesctoPrestQuirogMensual '/ 30 * 15
    'Asiste_TranspP = Asiste_TransporteMensual
    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)

    'Asiste_ImpuestoRenta = 0
    'If Contrato IsNot Nothing AndAlso Me.Contrato.Contra_afiliess AndAlso Asiste_DescontarImpuestoRenta Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos '+ DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacacionesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica '/ 15 * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, mPeriodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm '/ 30 * 15
    '  End If
    'End If
    'Asiste_SeguroCorporativo = 0
    'If Asiste_DescontarSeguro Then
    '  Asiste_SeguroCorporativo = Empleado.PardetSeguroCorporativo.Pardet_DatoDec1
    'End If
    'Asiste_SueldoPagar = Total_periodo
  End Sub

  Private Sub Calcular_Fijo_Quincenal(ByVal _solocalculo As Boolean)
    Dim faltad1 As Boolean = False
    Dim faltadd1 As Boolean = False
    Dim faltam1 As Boolean = False
    Dim faltad2 As Boolean = False
    Dim faltadd2 As Boolean = False
    Dim faltam2 As Boolean = False
    Dim nodias As Integer = 0
    Dim fsemana As Integer = 0
    Dim diaslv As Integer = 0

    Dim _dias As DiaAsistenciaList
    _dias = Me.Dias

    Dim _horasquincena As Integer = 0
    If Me.Asiste_TurnosRotativos Then
      For t As Integer = 1 To mPeriodopago.IntervaloDias
        Dim diaasis As DiaAsistencia
        diaasis = _dias(t - 1)
        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre And fsemana < 6 Then
          fsemana += 1
        Else
          diaslv += 1
        End If
        'If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        '  fsemana += 1
        'Else
        '  diaslv += 1
        'End If

        _horasquincena += diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux
        Select Case diaasis.Pardet_EstadoDiaEnum
          Case Enumerados.enumEstadoModeloLabor.Permiso, Enumerados.enumEstadoModeloLabor.SinSueldo, Enumerados.enumEstadoModeloLabor.DiaLibre, Enumerados.enumEstadoModeloLabor.Feriado, Enumerados.enumEstadoModeloLabor.Vacaciones
          Case Else
            If diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux = 0 Then
              If t <= 7 Then
                If Not faltad1 Then
                  faltad1 = True
                Else
                  faltadd1 = True
                End If
              Else
                If Not faltad2 Then
                  faltad2 = True
                Else
                  faltadd2 = True
                End If
              End If
            End If
        End Select
      Next
    Else
      For t As Integer = 1 To mPeriodopago.IntervaloDias
        Dim diaasis As DiaAsistencia
        diaasis = _dias(t - 1)
        If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
          fsemana += 1
        Else
          diaslv += 1
          Select Case diaasis.Pardet_EstadoDiaEnum
            Case Enumerados.enumEstadoModeloLabor.Permiso, Enumerados.enumEstadoModeloLabor.SinSueldo, Enumerados.enumEstadoModeloLabor.DiaLibre, Enumerados.enumEstadoModeloLabor.Feriado, Enumerados.enumEstadoModeloLabor.Vacaciones
            Case Else
              If diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux = 0 Then
                If t <= 7 Then
                  If Not faltad1 Then
                    faltad1 = True
                  Else
                    faltadd1 = True
                  End If
                Else
                  If Not faltad2 Then
                    faltad2 = True
                  Else
                    faltadd2 = True
                  End If
                End If
              ElseIf (diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux) < diaasis.Tarea.Tarea_Meta Then
                If t <= 7 Then
                  If Not faltam1 Then
                    faltam1 = True
                  Else
                    If Not faltad1 Then
                      faltad1 = True
                    Else
                      faltadd1 = True
                    End If
                  End If
                Else
                  If Not faltam2 Then
                    faltam2 = True
                  Else
                    If Not faltad2 Then
                      faltad2 = True
                    Else
                      faltadd2 = True
                    End If
                  End If
                End If
              End If
          End Select
        End If
      Next
    End If

    Dim isab1 As Double = 1
    Dim idom1 As Double = 1 'IIf(diaslv >= 12, 0, 1)
    Dim isab2 As Double = 1
    Dim idom2 As Double = 1 'IIf(diaslv >= 13, 0, 1)
    Dim iadd As Double = 0

    If faltam1 Then isab1 = 0.5
    If faltad1 Then idom1 = 0
    If faltadd1 Then
      isab1 = 0
      idom1 = 0
    End If
    If faltam2 Then isab2 = 0.5
    If faltad2 Then idom2 = 0
    If faltadd2 Then
      isab2 = 0
      idom2 = 0
    End If

    iadd = 15 - (diaslv + IIf(fsemana < 4, fsemana, 4))

    'nodias = dias que no deben ser contados pq exceden los 15 dias
    '15-fsemana = dias normales
    'fsemana = número de fines de semana
    'iadd = (fsemana - 4) - nodias

    ' 2 parte poner en orden
    Dim prestpagado As Decimal = 0.0
    Dim anticipos As Decimal = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Decimal = 0.0
    Dim diasvac As Integer = 0
    Dim diasfaltas As Decimal = 0
    Dim smatenf As Decimal = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    Dim s0 As Decimal = 0.0
    Dim s25 As Decimal = 0.0
    Dim s50 As Decimal = 0.0
    Dim s100 As Decimal = 0.0
    Dim s100b As Decimal = 0.0
    Dim adic As Decimal = 0.0
    Dim libre As Decimal = 0.0
    Dim transp As Decimal = 0.0
    Dim cs As Decimal = 0.0
    Dim iess As Decimal = 0.0

    Dim contfsemana As Integer = 0

    'Dim contdsemana As Integer = 0
    Dim conthquincena As Integer = 0
    For t As Integer = 1 To mPeriodopago.IntervaloDias
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)

      diaasis.DiaAsi_integrales = 0

      If Me.Asiste_TurnosRotativos Then
        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
          contfsemana += 1
          Dim _integ As Integer = 0
          If contfsemana <= fsemana Then
            _integ = 1
          End If
          diaasis.DiaAsi_integrales = _integ
        End If

        If Not diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
          diaasis.DiaAsi_Jornada = 0
          diaasis.DiaAsi_Sobret25 = 0
          diaasis.DiaAsi_Sobret50 = 0
          diaasis.DiaAsi_Sobret100 = 0
          diaasis.DiaAsi_Sobret100b = 0

          If conthquincena + diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux <= 80 Then
            diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux
          Else
            diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux
            diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux
            diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux
            diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux
            diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux

            '80-36=4
            Dim difhpara80 As Integer = 80 - (IIf(conthquincena > 80, 80, conthquincena) + diaasis.DiaAsi_Jornadaaux)
            If difhpara80 < 0 Then
              Dim resta As Integer = -difhpara80
              Dim dif As Integer = 0
              dif = IIf(diaasis.DiaAsi_Jornadaaux >= resta, resta, diaasis.DiaAsi_Jornadaaux)
              diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux - dif
              resta -= dif

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret25aux >= resta, resta, diaasis.DiaAsi_Sobret25aux)
                diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret50aux >= resta, resta, diaasis.DiaAsi_Sobret50aux)
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100aux >= resta, resta, diaasis.DiaAsi_Sobret100aux)
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100baux >= resta, resta, diaasis.DiaAsi_Sobret100baux)
                diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux - dif
                resta -= dif
              End If

              'sumar diferencia
              If (diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday) Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - difhpara80
              Else
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - difhpara80
              End If
            Else ' difhpara80<0
              Dim suma As Integer = difhpara80
              Dim dif As Integer = 0
              'dif = IIf(diaasis.DiaAsi_Jornadaaux >= resta, resta, diaasis.DiaAsi_Jornadaaux)
              'diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux - dif
              'resta -= dif

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret25aux >= suma, suma, diaasis.DiaAsi_Sobret25aux)
                diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret50aux >= suma, suma, diaasis.DiaAsi_Sobret50aux)
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100aux >= suma, suma, diaasis.DiaAsi_Sobret100aux)
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100baux >= suma, suma, diaasis.DiaAsi_Sobret100baux)
                diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux - dif
                suma -= dif
              End If

              'restar diferencia

              diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux + difhpara80
            End If
          End If

          conthquincena += diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux
        End If
      Else 'no rotativo
        If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
          contfsemana += 1
          Dim _integ As Integer = 0
          If contfsemana > 4 Then
            _integ = 0
          Else
            If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
              If t <= 7 Then
                _integ = isab1
              Else
                _integ = isab2
              End If
            End If
            If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
              If t <= 7 Then
                _integ = idom1
              Else
                _integ = idom2
              End If
            End If
          End If

          If _integ > 0 Then
            If iadd < 0 Then 'And diaasis.DiaAsi_integrales > 0 
              iadd += _integ
              _integ = 0
            End If
            If iadd > 0 Then
              iadd -= 1
              _integ += 1
            End If
          End If
          diaasis.DiaAsi_integrales = _integ
        End If

        diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux
        diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux
        diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux
        diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux
        diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux
      End If

      diario += diaasis.DiaAsi_diario
      diasfaltas += diaasis.DiaAsi_Falta
      diasint += diaasis.DiaAsi_integrales
      diasvac += diaasis.DiaAsi_vacaciones
      'smatenf += diaasis.DiaAsi_valorsubmatenf
      h0 += diaasis.DiaAsi_H0
      h25 += diaasis.DiaAsi_H25
      h50 += diaasis.DiaAsi_H50
      h100 += diaasis.DiaAsi_H100
      h100b += diaasis.DiaAsi_H100b
      's0 += diaasis.DiaAsi_ValorH0 + diaasis.DiaAsi_ValorIntegral
      's25 += diaasis.DiaAsi_ValorH25
      's50 += diaasis.DiaAsi_ValorH50
      's100 += diaasis.DiaAsi_ValorH100
      'adic += diaasis.DiaAsi_Valoradicional
      'libre += diaasis.DiaAsi_ValorHLibre
      'transp += diaasis.DiaAsi_Valortransporte
      'cs += diaasis.DiaAsi_ValorCompSal
      'iess += diaasis.DiaAsi_ValorIESS
    Next

    Asiste_Dias = diario + diasint
    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    'Zafra = Me.CtlZafra1.Zafra
    'Asiste_Diario = diario
    Asiste_Faltas = diasfaltas
    Asiste_DiasIntegrales = diasint
    Asiste_FaltasIntegrales = iif(diasint > fsemana, 0, fsemana - diasint)
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b
    'Asiste_SubMatEnf = smatenf
    'Asiste_ICS = cs
    'Asiste_S0 = s0
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_IESS = iess
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_PrestamoQuirog = Contrato.Empleado.Emplea_DesctoPrestQuirogMensual '/ 30 * 15
    'Asiste_AdicionalP = adic
    'Asiste_Libre = libre
    'Asiste_TranspP = transp
    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)

    'If Contrato IsNot Nothing Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos + DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacacionesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica / 15 * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, mPeriodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm / 30 * 15
    '  End If
    'End If
    'Asiste_SueldoPagar = Total_periodo
  End Sub

  Private Sub Calcular_Temporada_Quincenal(ByVal _solocalculo As Boolean)
    Dim faltad1 As Boolean = False
    Dim faltadd1 As Boolean = False
    Dim faltam1 As Boolean = False
    Dim faltad2 As Boolean = False
    Dim faltadd2 As Boolean = False
    Dim faltam2 As Boolean = False
    Dim nodias As Integer = 0
    Dim fsemana As Integer = 0
    Dim diaslv As Integer = 0

    Dim _dias As DiaAsistenciaList
    _dias = Me.Dias

    Dim _horasquincena As Integer = 0
    If Me.Asiste_TurnosRotativos Then
      For t As Integer = 1 To mPeriodopago.IntervaloDias
        Dim diaasis As DiaAsistencia
        diaasis = _dias(t - 1)
        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre And fsemana < 6 Then
          fsemana += 1
        Else
          diaslv += 1
        End If
        'If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        '  fsemana += 1
        'Else
        '  diaslv += 1
        'End If

        _horasquincena += diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux

        Select Case diaasis.Pardet_EstadoDiaEnum
          Case Enumerados.enumEstadoModeloLabor.Permiso, Enumerados.enumEstadoModeloLabor.SinSueldo, Enumerados.enumEstadoModeloLabor.DiaLibre, Enumerados.enumEstadoModeloLabor.Feriado, Enumerados.enumEstadoModeloLabor.Vacaciones
          Case Else
            If diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux = 0 Then
              If t <= 7 Then
                If Not faltad1 Then
                  faltad1 = True
                Else
                  faltadd1 = True
                End If
              Else
                If Not faltad2 Then
                  faltad2 = True
                Else
                  faltadd2 = True
                End If
              End If
            End If
        End Select
      Next
    Else
      For t As Integer = 1 To mPeriodopago.IntervaloDias
        Dim diaasis As DiaAsistencia
        diaasis = _dias(t - 1)
        If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
          fsemana += 1
        Else
          diaslv += 1
          Select Case diaasis.Pardet_EstadoDiaEnum
            Case Enumerados.enumEstadoModeloLabor.Permiso, Enumerados.enumEstadoModeloLabor.SinSueldo, Enumerados.enumEstadoModeloLabor.DiaLibre, Enumerados.enumEstadoModeloLabor.Feriado, Enumerados.enumEstadoModeloLabor.Vacaciones
            Case Else
              If diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux = 0 Then
                If t <= 7 Then
                  If Not faltad1 Then
                    faltad1 = True
                  Else
                    faltadd1 = True
                  End If
                Else
                  If Not faltad2 Then
                    faltad2 = True
                  Else
                    faltadd2 = True
                  End If
                End If
              ElseIf (diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux) < diaasis.Tarea.Tarea_Meta Then
                If t <= 7 Then
                  If Not faltam1 Then
                    faltam1 = True
                  Else
                    If Not faltad1 Then
                      faltad1 = True
                    Else
                      faltadd1 = True
                    End If
                  End If
                Else
                  If Not faltam2 Then
                    faltam2 = True
                  Else
                    If Not faltad2 Then
                      faltad2 = True
                    Else
                      faltadd2 = True
                    End If
                  End If
                End If
              End If
          End Select
        End If
      Next
    End If

    Dim isab1 As Double = 1
    Dim idom1 As Double = 1 'IIf(diaslv >= 12, 0, 1)
    Dim isab2 As Double = 1
    Dim idom2 As Double = 1 'IIf(diaslv >= 13, 0, 1)
    Dim iadd As Double = 0

    If faltam1 Then isab1 = 0.5
    If faltad1 Then idom1 = 0
    If faltadd1 Then
      isab1 = 0
      idom1 = 0
    End If
    If faltam2 Then isab2 = 0.5
    If faltad2 Then idom2 = 0
    If faltadd2 Then
      isab2 = 0
      idom2 = 0
    End If

    iadd = 15 - (diaslv + 4)

    'nodias = dias que no deben ser contados pq exceden los 15 dias
    '15-fsemana = dias normales
    'fsemana = número de fines de semana
    'iadd = (fsemana - 4) - nodias

    ' 2 parte poner en orden
    Dim prestpagado As Decimal = 0.0
    Dim anticipos As Decimal = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Decimal = 0.0
    Dim diasvac As Integer = 0
    Dim diasfaltas As Decimal = 0
    Dim smatenf As Decimal = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    Dim s0 As Decimal = 0.0
    Dim s25 As Decimal = 0.0
    Dim s50 As Decimal = 0.0
    Dim s100 As Decimal = 0.0
    Dim s100b As Decimal = 0.0
    Dim adic As Decimal = 0.0
    Dim libre As Decimal = 0.0
    Dim transp As Decimal = 0.0
    Dim cs As Decimal = 0.0
    Dim iess As Decimal = 0.0

    Dim contfsemana As Integer = 0

    'Dim contdsemana As Integer = 0
    Dim conthquincena As Integer = 0
    For t As Integer = 1 To mPeriodopago.IntervaloDias
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)

      diaasis.DiaAsi_integrales = 0

      If Me.Asiste_TurnosRotativos Then
        'contdsemana += 1
        'If contdsemana > 7 Then
        '  contdsemana = 1
        '  conthquincena = 0
        'End If

        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
          contfsemana += 1
          Dim _integ As Integer = 0
          If contfsemana <= fsemana Then
            _integ = 1
          End If
          'If contfsemana > 4 Then
          '  _integ = 0
          'Else
          '  If contfsemana Mod 2 = 1 Then
          '    If t <= 7 Then
          '      _integ = isab1
          '    Else
          '      _integ = isab2
          '    End If
          '  End If
          '  If contfsemana Mod 2 = 0 Then
          '    If t <= 7 Then
          '      _integ = idom1
          '    Else
          '      _integ = idom2
          '    End If
          '  End If
          'End If

          'If _integ > 0 Then
          '  If iadd < 0 Then 'And diaasis.DiaAsi_integrales > 0 
          '    iadd += _integ
          '    _integ = 0
          '  End If
          '  If iadd > 0 And fsemana <= 6 Then
          '    iadd -= 1
          '    _integ += 1
          '  End If
          'End If
          diaasis.DiaAsi_integrales = _integ
        End If

        If Not diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Then
          diaasis.DiaAsi_Jornada = 0
          diaasis.DiaAsi_Sobret25 = 0
          diaasis.DiaAsi_Sobret50 = 0
          diaasis.DiaAsi_Sobret100 = 0
          diaasis.DiaAsi_Sobret100b = 0

          If conthquincena + diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux <= 80 Then
            diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux
          Else
            diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux
            diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux
            diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux
            diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux
            diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux

            '80-36=4
            Dim difhpara80 As Integer = 80 - (IIf(conthquincena > 80, 80, conthquincena) + diaasis.DiaAsi_Jornadaaux)
            If difhpara80 < 0 Then
              Dim resta As Integer = -difhpara80
              Dim dif As Integer = 0
              dif = IIf(diaasis.DiaAsi_Jornadaaux >= resta, resta, diaasis.DiaAsi_Jornadaaux)
              diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux - dif
              resta -= dif

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret25aux >= resta, resta, diaasis.DiaAsi_Sobret25aux)
                diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret50aux >= resta, resta, diaasis.DiaAsi_Sobret50aux)
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100aux >= resta, resta, diaasis.DiaAsi_Sobret100aux)
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - dif
                resta -= dif
              End If

              If resta > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100baux >= resta, resta, diaasis.DiaAsi_Sobret100baux)
                diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux - dif
                resta -= dif
              End If

              'sumar diferencia
              If (diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday) Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - difhpara80
              Else
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - difhpara80
              End If
            Else ' difhpara80<0
              Dim suma As Integer = difhpara80
              Dim dif As Integer = 0
              'dif = IIf(diaasis.DiaAsi_Jornadaaux >= resta, resta, diaasis.DiaAsi_Jornadaaux)
              'diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux - dif
              'resta -= dif

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret25aux >= suma, suma, diaasis.DiaAsi_Sobret25aux)
                diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret50aux >= suma, suma, diaasis.DiaAsi_Sobret50aux)
                diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100aux >= suma, suma, diaasis.DiaAsi_Sobret100aux)
                diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux - dif
                suma -= dif
              End If

              If suma > 0 Then
                dif = IIf(diaasis.DiaAsi_Sobret100baux >= suma, suma, diaasis.DiaAsi_Sobret100baux)
                diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux - dif
                suma -= dif
              End If

              'restar diferencia

              diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux + difhpara80
            End If
          End If

          conthquincena += diaasis.DiaAsi_Jornadaaux + diaasis.DiaAsi_Sobret25aux + diaasis.DiaAsi_Sobret50aux + diaasis.DiaAsi_Sobret100aux + diaasis.DiaAsi_Sobret100baux
        End If
      Else
        If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
          contfsemana += 1
          Dim _integ As Integer = 0
          If contfsemana > 4 Then
            _integ = 0
          Else
            If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
              If t <= 7 Then
                _integ = isab1
              Else
                _integ = isab2
              End If
            End If
            If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
              If t <= 7 Then
                _integ = idom1
              Else
                _integ = idom2
              End If
            End If
          End If

          If _integ > 0 Then
            If iadd < 0 Then 'And diaasis.DiaAsi_integrales > 0 
              iadd += _integ
              _integ = 0
            End If
            If iadd > 0 Then
              iadd -= 1
              _integ += 1
            End If
          End If
          diaasis.DiaAsi_integrales = _integ
        End If

        diaasis.DiaAsi_Jornada = diaasis.DiaAsi_Jornadaaux
        diaasis.DiaAsi_Sobret25 = diaasis.DiaAsi_Sobret25aux
        diaasis.DiaAsi_Sobret50 = diaasis.DiaAsi_Sobret50aux
        diaasis.DiaAsi_Sobret100 = diaasis.DiaAsi_Sobret100aux
        diaasis.DiaAsi_Sobret100b = diaasis.DiaAsi_Sobret100baux
      End If

      diario += diaasis.DiaAsi_diario
      diasfaltas += diaasis.DiaAsi_Falta
      diasint += diaasis.DiaAsi_integrales
      diasvac += diaasis.DiaAsi_vacaciones
      'smatenf += diaasis.DiaAsi_valorsubmatenf
      h0 += diaasis.DiaAsi_H0
      h25 += diaasis.DiaAsi_H25
      h50 += diaasis.DiaAsi_H50
      h100 += diaasis.DiaAsi_H100
      h100b += diaasis.DiaAsi_H100b
      's0 += diaasis.DiaAsi_ValorH0 + diaasis.DiaAsi_ValorIntegral
      's25 += diaasis.DiaAsi_ValorH25
      's50 += diaasis.DiaAsi_ValorH50
      's100 += diaasis.DiaAsi_ValorH100
      'adic += diaasis.DiaAsi_Valoradicional
      'libre += diaasis.DiaAsi_ValorHLibre
      'transp += diaasis.DiaAsi_Valortransporte
      'cs += diaasis.DiaAsi_ValorCompSal
      'iess += diaasis.DiaAsi_ValorIESS
    Next

    Asiste_Dias = diario + diasint
    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    'Zafra = Me.CtlZafra1.Zafra
    'Asiste_Diario = diario
    Asiste_Faltas = 0 'diasfaltas
    Asiste_DiasIntegrales = diasint
    Asiste_FaltasIntegrales = fsemana - diasint
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b
    'Asiste_SubMatEnf = smatenf
    'Asiste_ICS = cs
    'Asiste_S0 = s0
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_IESS = iess
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_PrestamoQuirog = Contrato.Empleado.Emplea_DesctoPrestQuirogMensual '/ 30 * 15
    'Asiste_AdicionalP = adic
    'Asiste_Libre = libre
    'Asiste_TranspP = transp
    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)

    'If Contrato IsNot Nothing Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos + DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacacionesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica / 15 * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, mPeriodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm / 30 * 15
    '  End If
    'End If
    'Asiste_SueldoPagar = Total_periodo
  End Sub

  Private Function Calcular_prestamo(ByVal _diastrab As Double, ByVal _solocalculo As Boolean, ByVal _Contrato As Contrato, ByVal _tipoprestamo As Enumerados.enumTipoPrestamo) As Decimal
    Dim prestpagado As Decimal = 0
    Dim pagosprests As PrestamoDetList
    pagosprests = PrestamoDetList.ObtenerLista(_Contrato, mPeriodopago.PerPag_FechaHasta, _tipoprestamo)
    If Not pagosprests Is Nothing Then
      For Each _pagos As PrestamoDet In pagosprests
        If Not _solocalculo Then
          Try
            If Not _pagos.Eliminar() Then
              Throw New Exception(_pagos.OperadorDatos.MsgError)
            End If
          Catch ex As Exception
            MsgBox(ex.Message)
          End Try
        Else
          prestpagado += _pagos.DetPre_Valor
        End If
      Next
    End If

    'If Asiste_DescontarPrestamo And (Not _solocalculo) And _diastrab > 0 Then
    '  Dim prestamos As PrestamoList
    '  prestamos = PrestamoList.ObtenerLista(OperadorDatos, _Contrato, PrestamoList.enumReportePrestamo.NoCancelados, Nothing, Nothing, New WWTSParametroDet(OperadorDatos, Enumerados.EnumParametros.TipoPrestamo, _tipoprestamo))
    '  If Not prestamos Is Nothing Then
    '    'Dim _prest As Prestamo = prestamos(0)
    '    For Each _prest As Prestamo In prestamos
    '      'Dim pagosprests As PrestamoDetList
    '      pagosprests = PrestamoDetList.ObtenerLista(_prest)

    '      Dim okprest As Boolean = True
    '      If Not pagosprests Is Nothing Then
    '        For Each _pgp As PrestamoDet In pagosprests
    '          If _pgp.DetPre_Fecha = Me.mPeriodopago.PerPag_FechaHasta Then
    '            okprest = False
    '            prestpagado += _pgp.DetPre_Valor
    '          End If
    '        Next
    '      End If

    '      If okprest And _prest.Presta_ValorAprobado > 0 Then 'And prestpagado = 0
    '        Dim pagoprest As New PrestamoDet(_prest)
    '        pagoprest.DetPre_Valor = _prest.Presta_ValorCuota
    '        If _prest.Presta_ValorCuota > (_prest.Presta_ValorAprobado - _prest.TotalPagado) Then
    '          pagoprest.DetPre_Valor = _prest.Presta_ValorAprobado - _prest.TotalPagado
    '        End If
    '        pagoprest.DetPre_Fecha = mPeriodopago.PerPag_FechaHasta
    '        If pagoprest.Guardar Then
    '          prestpagado += pagoprest.DetPre_Valor
    '        End If
    '      End If
    '    Next
    '  End If
    'End If
    Return prestpagado
  End Function

  Private Sub Calcular_Fijo_Semanal(ByVal _solocalculo As Boolean)
    Dim faltad1 As Boolean = False
    Dim faltadd1 As Boolean = False
    Dim faltam1 As Boolean = False
    Dim menossab1 As Boolean = False
    Dim menosdom1 As Boolean = False

    Dim faltad2 As Boolean = False
    Dim faltadd2 As Boolean = False
    Dim faltam2 As Boolean = False
    Dim menossab2 As Boolean = False
    Dim menosdom2 As Boolean = False

    Dim _dias As DiaAsistenciaList
    _dias = Me.Dias
    Dim difdays As Integer = mPeriodopago.IntervaloDias
    For t As Integer = 1 To difdays
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)
      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then
          If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
            If t <= 7 Then menossab1 = True Else menossab2 = True
          End If
          If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
            If t <= 7 Then menosdom1 = True Else menosdom2 = True
          End If
        End If
      Else
        If Not (diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Permiso Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.SinSueldo Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado) Then
          If diaasis.DiaAsi_Jornada = 0 Then
            If t <= 7 Then
              If Not faltad1 Then faltad1 = True Else faltadd1 = True
            Else
              If Not faltad2 Then faltad2 = True Else faltadd2 = True
            End If
          ElseIf diaasis.DiaAsi_Jornada > 0 And diaasis.DiaAsi_Jornada < diaasis.Tarea.Tarea_Meta Then
            If t <= 7 Then
              If Not faltam1 Then
                faltam1 = True
              Else
                If Not faltad1 Then faltad1 = True Else faltadd1 = True
              End If
            Else
              If Not faltam2 Then
                faltam2 = True
              Else
                If Not faltad2 Then faltad2 = True Else faltadd2 = True
              End If
            End If
          End If
        End If
      End If
    Next

    Dim isab1 As Double = 1
    Dim idom1 As Double = 1

    If faltam1 Then isab1 = 0.5
    If faltad1 Then idom1 = 0
    If faltadd1 Then
      isab1 = 0
      idom1 = 0
    End If
    If menossab1 Then isab1 = 0
    If menosdom1 Then idom1 = 0

    Dim isab2 As Double = 0
    Dim idom2 As Double = 0

    If difdays > 7 Then
      isab2 = 1
      idom2 = 1
      If faltam2 Then isab2 = 0.5
      If faltad2 Then idom2 = 0
      If faltadd2 Then
        isab2 = 0
        idom2 = 0
      End If
      If menossab2 Then isab2 = 0
      If menosdom2 Then idom2 = 0
    End If

    ' 2 parte poner en orden
    Dim prestpagado As Double = 0.0
    Dim anticipos As Double = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Double = 0.0
    Dim diasvac As Integer = 0
    Dim smatenf As Double = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    Dim s0 As Double = 0.0
    Dim s25 As Double = 0.0
    Dim s50 As Double = 0.0
    Dim s100 As Double = 0.0
    Dim s100b As Double = 0.0
    Dim adic As Double = 0.0
    Dim libre As Double = 0.0
    Dim transp As Double = 0.0
    Dim cs As Double = 0.0
    Dim iess As Double = 0.0

    For t As Integer = 1 To difdays
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)

      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
        diaasis.DiaAsi_integrales = IIf(t <= 7, isab1, isab2)
      End If
      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        diaasis.DiaAsi_integrales = IIf(t <= 7, idom1, idom2)
      End If

      diario += diaasis.DiaAsi_diario
      diasint += diaasis.DiaAsi_integrales
      diasvac += diaasis.DiaAsi_vacaciones
      'smatenf += diaasis.DiaAsi_valorsubmatenf
      h0 += diaasis.DiaAsi_H0
      h25 += diaasis.DiaAsi_H25
      h50 += diaasis.DiaAsi_H50
      h100 += diaasis.DiaAsi_H100
      's0 += diaasis.DiaAsi_ValorH0 + diaasis.DiaAsi_ValorIntegral
      's25 += diaasis.DiaAsi_ValorH25
      's50 += diaasis.DiaAsi_ValorH50
      's100 += diaasis.DiaAsi_ValorH100
      'adic += diaasis.DiaAsi_Valoradicional
      'libre += diaasis.DiaAsi_ValorHLibre
      'transp += diaasis.DiaAsi_Valortransporte
      'cs += diaasis.DiaAsi_ValorCompSal
      'iess += diaasis.DiaAsi_ValorIESS
    Next

    Asiste_Dias = diario + diasint
    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    'Zafra = Me.CtlZafra1.Zafra
    'Asiste_Diario = diario
    Asiste_DiasIntegrales = diasint
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b
    'Asiste_SubMatEnf = smatenf
    'Asiste_ICS = cs
    'Asiste_S0 = s0
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_IESS = iess
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_PrestamoQuirog = Contrato.Empleado.Emplea_DesctoPrestQuirogMensual ' / 30 * difdays
    'Asiste_AdicionalP = adic
    'Asiste_Libre = libre
    'Asiste_TranspP = transp

    'If Contrato IsNot Nothing Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos + DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacaciopnesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica / mPeriodopago.IntervaloDias * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, Periodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm / 30 * Periodopago.IntervaloDias
    '  End If
    'End If

    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)
    'Asiste_SueldoPagar = Total_periodo
  End Sub

  Private Sub Calcular_PorHoras_Semanal(ByVal _solocalculo As Boolean)
    ' 2 parte poner en orden
    Dim prestpagado As Double = 0.0
    Dim anticipos As Double = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Double = 0.0
    Dim diasvac As Integer = 0
    Dim smatenf As Double = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    Dim s0 As Double = 0.0
    Dim s25 As Double = 0.0
    Dim s50 As Double = 0.0
    Dim s100 As Double = 0.0
    Dim s100b As Double = 0.0
    Dim adic As Double = 0.0
    Dim libre As Double = 0.0
    Dim transp As Double = 0.0
    Dim cs As Double = 0.0
    Dim iess As Double = 0.0

    Dim _dias As DiaAsistenciaList
    _dias = Me.Dias
    Dim difdays As Integer = mPeriodopago.IntervaloDias
    For t As Integer = 1 To difdays
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)

      diario += diaasis.DiaAsi_diario
      diasint += diaasis.DiaAsi_integrales
      diasvac += diaasis.DiaAsi_vacaciones
      'smatenf += diaasis.DiaAsi_valorsubmatenf
      h0 += diaasis.DiaAsi_H0
      h25 += diaasis.DiaAsi_H25
      h50 += diaasis.DiaAsi_H50
      h100 += diaasis.DiaAsi_H100
      's0 += diaasis.DiaAsi_ValorH0 + diaasis.DiaAsi_ValorIntegral
      's25 += diaasis.DiaAsi_ValorH25
      's50 += diaasis.DiaAsi_ValorH50
      's100 += diaasis.DiaAsi_ValorH100
      'adic += diaasis.DiaAsi_Valoradicional
      'libre += diaasis.DiaAsi_ValorHLibre
      'transp += diaasis.DiaAsi_Valortransporte
      'cs += diaasis.DiaAsi_ValorCompSal
      'iess += diaasis.DiaAsi_ValorIESS
    Next

    Asiste_Dias = diario + diasint
    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    'Zafra = Me.CtlZafra1.Zafra
    'Asiste_Diario = diario
    Asiste_DiasIntegrales = diasint
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b
    'Asiste_SubMatEnf = smatenf
    'Asiste_ICS = cs
    'Asiste_S0 = s0
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_IESS = iess
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_PrestamoQuirog = Empleado.Emplea_DesctoPrestQuirogMensual ' / 30 * difdays
    'Asiste_AdicionalP = adic
    'Asiste_Libre = libre
    'Asiste_TranspP = transp

    'If Contrato IsNot Nothing Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos + DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacaciopnesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica / mPeriodopago.IntervaloDias * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, mPeriodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm / 30 * Periodopago.IntervaloDias
    '  End If
    'End If

    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)
    'Asiste_SueldoPagar = Total_periodo
  End Sub
  Private Sub Calcular_Temporada_Semanal(ByVal _solocalculo As Boolean)
    Dim faltad1 As Boolean = False
    Dim faltadd1 As Boolean = False
    Dim faltam1 As Boolean = False
    Dim menossab1 As Boolean = False
    Dim menosdom1 As Boolean = False

    Dim faltad2 As Boolean = False
    Dim faltadd2 As Boolean = False
    Dim faltam2 As Boolean = False
    Dim menossab2 As Boolean = False
    Dim menosdom2 As Boolean = False

    Dim _dias As DiaAsistenciaList
    _dias = Me.Dias
    Dim difdays As Integer = mPeriodopago.IntervaloDias
    For t As Integer = 1 To difdays
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)
      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Or diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        If diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado Then
          If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
            If t <= 7 Then menossab1 = True Else menossab2 = True
          End If
          If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
            If t <= 7 Then menosdom1 = True Else menosdom2 = True
          End If
        End If
      Else
        If Not (diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Permiso Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.SinSueldo Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.DiaLibre Or diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.Feriado) Then
          If diaasis.DiaAsi_Jornada = 0 Then
            If t <= 7 Then
              If Not faltad1 Then faltad1 = True Else faltadd1 = True
            Else
              If Not faltad2 Then faltad2 = True Else faltadd2 = True
            End If
          ElseIf diaasis.DiaAsi_Jornada > 0 And diaasis.DiaAsi_Jornada < diaasis.Tarea.Tarea_Meta Then
            If t <= 7 Then
              If Not faltam1 Then
                faltam1 = True
              Else
                If Not faltad1 Then faltad1 = True Else faltadd1 = True
              End If
            Else
              If Not faltam2 Then
                faltam2 = True
              Else
                If Not faltad2 Then faltad2 = True Else faltadd2 = True
              End If
            End If
          End If
        End If
      End If
    Next

    Dim isab1 As Double = 1
    Dim idom1 As Double = 1

    If faltam1 Then isab1 = 0.5
    If faltad1 Then idom1 = 0
    If faltadd1 Then
      isab1 = 0
      idom1 = 0
    End If
    If menossab1 Then isab1 = 0
    If menosdom1 Then idom1 = 0

    Dim isab2 As Double = 0
    Dim idom2 As Double = 0

    If difdays > 7 Then
      isab2 = 1
      idom2 = 1
      If faltam2 Then isab2 = 0.5
      If faltad2 Then idom2 = 0
      If faltadd2 Then
        isab2 = 0
        idom2 = 0
      End If
      If menossab2 Then isab2 = 0
      If menosdom2 Then idom2 = 0
    End If

    ' 2 parte poner en orden
    Dim prestpagado As Double = 0.0
    Dim anticipos As Double = 0.0
    Dim diario As Decimal = 0
    Dim diasint As Double = 0.0
    Dim diasvac As Integer = 0
    Dim smatenf As Double = 0.0
    Dim h0 As Integer = 0
    Dim h25 As Integer = 0
    Dim h50 As Integer = 0
    Dim h100 As Integer = 0
    Dim h100b As Integer = 0
    Dim s0 As Double = 0.0
    Dim s25 As Double = 0.0
    Dim s50 As Double = 0.0
    Dim s100 As Double = 0.0
    Dim s100b As Double = 0.0
    Dim adic As Double = 0.0
    Dim libre As Double = 0.0
    Dim transp As Double = 0.0
    Dim cs As Double = 0.0
    Dim iess As Double = 0.0
    Dim d3 As Double = 0.0
    Dim vac As Double = 0.0

    For t As Integer = 1 To difdays
      Dim diaasis As DiaAsistencia
      diaasis = _dias(t - 1)

      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Saturday Then
        diaasis.DiaAsi_integrales = IIf(t <= 7, isab1, isab2)
      End If
      If diaasis.DiaAsi_Fecha.DayOfWeek = DayOfWeek.Sunday Then
        diaasis.DiaAsi_integrales = IIf(t <= 7, idom1, idom2)
      End If
      'diaasis.Guardar()
      diario += diaasis.DiaAsi_diario
      diasint += diaasis.DiaAsi_integrales
      diasvac += diaasis.DiaAsi_vacaciones
      'smatenf += diaasis.DiaAsi_valorsubmatenf
      h0 += diaasis.DiaAsi_H0
      h25 += diaasis.DiaAsi_H25
      h50 += diaasis.DiaAsi_H50
      h100 += diaasis.DiaAsi_H100
      's0 += diaasis.DiaAsi_ValorH0 + diaasis.DiaAsi_ValorIntegral
      's25 += diaasis.DiaAsi_ValorH25
      's50 += diaasis.DiaAsi_ValorH50
      's100 += diaasis.DiaAsi_ValorH100
      'adic += diaasis.DiaAsi_Valoradicional
      'libre += diaasis.DiaAsi_ValorHLibre
      'transp += diaasis.DiaAsi_Valortransporte
      'cs += diaasis.DiaAsi_ValorCompSal
      'iess += diaasis.DiaAsi_ValorIESS

      'd3 += diaasis.DiaAsi_D3pag
      'vac += diaasis.DiaAsi_Vacpag
    Next

    Asiste_Dias = diario + diasint
    prestpagado = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Prestamo)
    anticipos = Calcular_prestamo(Asiste_Dias, _solocalculo, Contrato, Enumerados.enumTipoPrestamo.Anticipo)
    'Zafra = Me.CtlZafra1.Zafra
    'Asiste_Diario = diario
    Asiste_DiasIntegrales = diasint
    'Asiste_DiasVac = diasvac
    Asiste_H0 = h0
    Asiste_H25 = h25
    Asiste_H50 = h50
    Asiste_H100 = h100
    Asiste_H100b = h100b
    'Asiste_SubMatEnf = smatenf
    'Asiste_ICS = cs
    'Asiste_S0 = s0
    'Asiste_S25 = s25
    'Asiste_S50 = s50
    'Asiste_S100 = s100
    'Asiste_S100b = s100b
    'Asiste_IESS = iess
    'Asiste_Prestamo = prestpagado
    'Asiste_Anticipos = anticipos
    'Asiste_PrestamoQuirog = Contrato.Empleado.Emplea_DesctoPrestQuirogMensual ' / 30 * difdays
    'Asiste_AdicionalP = adic
    'Asiste_Libre = libre
    'Asiste_TranspP = transp
    'mAsistencia.Asiste_multa = CType(Me.txtmultas.Text, Double)
    'calcular d3 y vacaciones
    'Asiste_D3Pag = d3
    'Asiste_VacPag = vac

    'If Contrato IsNot Nothing Then
    '  Dim fraccionbasica As Double
    '  fraccionbasica = Asiste_S0 + Asiste_S25 + Asiste_S50 + Asiste_S100 + Asiste_S100b + Asiste_AdicionalP + Asiste_Libre - Asiste_IESS + Asiste_OtrosIngresos + DecimoTerceroProporcional + DecimoCuartoProporcional '+ VacaciopnesProporcional
    '  Dim fraccionbasicam As Double
    '  fraccionbasicam = fraccionbasica / mPeriodopago.IntervaloDias * 30

    '  Dim ImpuestoRenta As ImpuestoRenta = ImpuestoRentaList.ObtenerLista(Me.Contrato.Patrono.Pais, mPeriodopago.PerPag_FechaHasta, fraccionbasicam)

    '  If ImpuestoRenta IsNot Nothing Then
    '    Dim irm As Double = ((fraccionbasicam - ImpuestoRenta.ImpRen_SueldoDesde) * ImpuestoRenta.ImpRen_PorcFraccionExcedente / 100) + ImpuestoRenta.ImpRen_FraccionBasica
    '    Asiste_ImpuestoRenta = irm / 30 * Periodopago.IntervaloDias
    '  End If
    'End If

    'Asiste_SueldoPagar = Total_periodo
  End Sub
#End Region

  Public Overridable Sub MapearDataRowaObjeto(ByVal Fila As DataRow)
    Entida_Codigo = CType(Fila("Entida_Codigo"), Integer)
    Patron_Codigo = CType(Fila("Patron_Codigo"), Integer)
    PerPag_FechaDesde = CType(Fila("PerPag_FechaDesde"), Date)
    Parame_PeriodoPago = CType(Fila("Parame_PeriodoPago"), Integer)
    Pardet_PeriodoPago = CType(Fila("Pardet_PeriodoPago"), Integer)
    Parame_SubCentroCosto = CType(Fila("Parame_SubCentroCosto"), Integer)
    Pardet_SubCentroCosto = CType(Fila("Pardet_SubCentroCosto"), Integer)
    Contra_Secuencia = CType(Fila("Contra_Secuencia"), Integer)
    Asiste_Dias = CType(Fila("Asiste_Dias"), Decimal)
    Asiste_DiasIntegrales = CType(Fila("Asiste_DiasIntegrales"), Decimal)
    Asiste_Faltas = CType(Fila("Asiste_Faltas"), Decimal)
    Asiste_DiasInactivos = CInt(Fila("Asiste_DiasInactivos"))
    Asiste_H0 = CType(Fila("Asiste_H0"), Integer)
    Asiste_H25 = CType(Fila("Asiste_H25"), Integer)
    Asiste_H50 = CType(Fila("Asiste_H50"), Integer)
    Asiste_H100 = CType(Fila("Asiste_H100"), Integer)
    Asiste_H100b = CType(Fila("Asiste_H100b"), Integer)
    Asiste_TurnosRotativos = CBool(Fila("Asiste_TurnosRotativos"))

    Try
      Asiste_FaltasIntegrales = CType(Fila("Asiste_FaltasIntegrales"), Integer)
    Catch ex As Exception
      Asiste_FaltasIntegrales = 0
    End Try

    mPeriodopago = Nothing
    mTipocontrato = Nothing
    mContrato = Nothing
    mPardetSubCentroCosto = Nothing
  End Sub

  Public Function RecargarContrato() As Boolean
    Dim dsResult As New DataTable
    Dim bResult As Boolean

    With Me.OperadorDatos
      .AgregarParametro("@accion", "CC")
      .AgregarParametro("@Patron_Codigo", Me.Patron_Codigo)
      .AgregarParametro("@Entida_Codigo", Me.Entida_Codigo)
      .AgregarParametro("@Contra_Secuencia", Me.Contra_Secuencia)
      .AgregarParametro("@PerPag_FechaDesde", Me.PerPag_FechaDesde)
      .AgregarParametro("@Parame_PeriodoPago", Parame_PeriodoPago)
      .AgregarParametro("@Pardet_PeriodoPago", Pardet_PeriodoPago)
      .Procedimiento = _Procedimiento
      bResult = .Ejecutar(dsResult)
      .LimpiarParametros()
    End With
    If bResult AndAlso dsResult IsNot Nothing AndAlso dsResult.Rows.Count > 0 Then
      Me.MapearDataRowaObjeto(dsResult.Rows(0))
      Return True
    Else
      Return False
    End If
  End Function
  Public Function RecargarEmpleado() As Boolean
    Dim dsResult As New DataTable
    Dim bResult As Boolean

    With Me.OperadorDatos
      .AgregarParametro("@accion", "CP")
      .AgregarParametro("@Patron_Codigo", Me.Patron_Codigo)
      .AgregarParametro("@Entida_Codigo", Me.Entida_Codigo)
      .AgregarParametro("@PerPag_FechaDesde", Me.PerPag_FechaDesde)
      .AgregarParametro("@Parame_PeriodoPago", Parame_PeriodoPago)
      .AgregarParametro("@Pardet_PeriodoPago", Pardet_PeriodoPago)
      .Procedimiento = _Procedimiento
      bResult = .Ejecutar(dsResult)
      .LimpiarParametros()
    End With
    If bResult AndAlso dsResult IsNot Nothing AndAlso dsResult.Rows.Count > 0 Then
      Me.MapearDataRowaObjeto(dsResult.Rows(0))
      Return True
    Else
      Return False
    End If
  End Function

  Public Overridable Function Recargar() As Boolean
    Dim Result As New DataTable
    Dim bReturn As Boolean = True
    OperadorDatos.AgregarParametro("@accion", "C")
    OperadorDatos.AgregarParametro("@Entida_Codigo", Entida_Codigo)
    OperadorDatos.AgregarParametro("@Patron_Codigo", Patron_Codigo)
    OperadorDatos.AgregarParametro("@PerPag_FechaDesde", PerPag_FechaDesde)
    OperadorDatos.AgregarParametro("@Parame_PeriodoPago", Parame_PeriodoPago)
    OperadorDatos.AgregarParametro("@Pardet_PeriodoPago", Pardet_PeriodoPago)
    OperadorDatos.Procedimiento = _Procedimiento
    bReturn = OperadorDatos.Ejecutar(Result)
    OperadorDatos.LimpiarParametros()
    Try
      Me.MapearDataRowaObjeto(Result.Rows(0))
      EsNuevo = False
      EsModificado = False
    Catch ex As System.Exception
      bReturn = False
    End Try
    Return bReturn
  End Function

  Public Overridable Function Guardar() As Boolean
    Dim Result As Integer = 0
    Dim bReturn As Boolean = True
    Dim sAccion As String = "M"
    If EsNuevo Then
      sAccion = "I"
    End If
    Dim _ComenzoTransaccion As Boolean = OperadorDatos.ComenzarTransaccion()

    OperadorDatos.AgregarParametro("@accion", sAccion)
    OperadorDatos.AgregarParametro("@Entida_Codigo", Entida_Codigo)
    OperadorDatos.AgregarParametro("@Patron_Codigo", Patron_Codigo)
    OperadorDatos.AgregarParametro("@PerPag_FechaDesde", PerPag_FechaDesde)
    OperadorDatos.AgregarParametro("@Parame_PeriodoPago", Parame_PeriodoPago)
    OperadorDatos.AgregarParametro("@Pardet_PeriodoPago", Pardet_PeriodoPago)
    OperadorDatos.AgregarParametro("@Parame_SubCentroCosto", Parame_SubCentroCosto)
    OperadorDatos.AgregarParametro("@Pardet_SubCentroCosto", Pardet_SubCentroCosto)
    OperadorDatos.AgregarParametro("@Contra_Secuencia", Contra_Secuencia)
    OperadorDatos.AgregarParametro("@Asiste_Dias", Asiste_Dias)
    OperadorDatos.AgregarParametro("@Asiste_DiasIntegrales", Asiste_DiasIntegrales)
    OperadorDatos.AgregarParametro("@Asiste_Faltas", Asiste_Faltas)
    OperadorDatos.AgregarParametro("@Asiste_DiasInactivos", Asiste_DiasInactivos)
    OperadorDatos.AgregarParametro("@Asiste_H0", Asiste_H0)
    OperadorDatos.AgregarParametro("@Asiste_H25", Asiste_H25)
    OperadorDatos.AgregarParametro("@Asiste_H50", Asiste_H50)
    OperadorDatos.AgregarParametro("@Asiste_H100", Asiste_H100)
    OperadorDatos.AgregarParametro("@Asiste_H100b", Asiste_H100b)
    OperadorDatos.AgregarParametro("@Asiste_TurnosRotativos", Asiste_TurnosRotativos)
    OperadorDatos.AgregarParametro("@Asiste_FaltasIntegrales", Asiste_FaltasIntegrales)
    OperadorDatos.Procedimiento = _Procedimiento
    bReturn = OperadorDatos.Ejecutar(Result)
    OperadorDatos.LimpiarParametros()
    If bReturn Then
      For Each _diaasis As DiaAsistencia In Dias
        If (Not _diaasis.Pardet_EstadoDiaEnum = Enumerados.enumEstadoModeloLabor.NoRegistra) Then
          If Not _diaasis.Guardar() Then
            bReturn = False
            Exit For
          End If
        Else
          If Not _diaasis.Eliminar() Then
            bReturn = False
            Exit For
          End If
        End If
      Next

      If bReturn Then
        'asistenciadet
        For Each _asisdet As AsistenciaDet In AsistenciaDetList
          If Not _asisdet.Guardar() Then
            bReturn = False
            Exit For
          End If
        Next
      End If
    End If
    If bReturn Then
      If _ComenzoTransaccion Then
        If OperadorDatos.TerminarTransaccion() Then
          AceptarCambios()
        Else
          bReturn = False
        End If
      End If
    Else
      If _ComenzoTransaccion Then
        OperadorDatos.CancelarTransaccion()
      End If
    End If
    Return bReturn
  End Function

  Public Overridable Sub AceptarCambios()
    EsNuevo = False
    EsModificado = False
    For Each _diaasis As DiaAsistencia In Dias
      _diaasis.AceptarCambios()
    Next
    For Each _asisdet As AsistenciaDet In AsistenciaDetList
      _asisdet.AceptarCambios()
    Next
  End Sub

  Public Overridable Function Eliminar() As Boolean
    Dim bReturn As Boolean = True
    OperadorDatos.AgregarParametro("@accion", "E")
    OperadorDatos.AgregarParametro("@Entida_Codigo", Entida_Codigo)
    OperadorDatos.AgregarParametro("@Patron_Codigo", Patron_Codigo)
    OperadorDatos.AgregarParametro("@PerPag_FechaDesde", PerPag_FechaDesde)
    OperadorDatos.AgregarParametro("@Parame_PeriodoPago", Parame_PeriodoPago)
    OperadorDatos.AgregarParametro("@Pardet_PeriodoPago", Pardet_PeriodoPago)
    OperadorDatos.Procedimiento = _Procedimiento
    bReturn = OperadorDatos.Ejecutar
    OperadorDatos.LimpiarParametros()
    Return bReturn
  End Function
End Class
#End Region

#Region "AsistenciaList"
Public Class AsistenciaList
  Inherits System.ComponentModel.BindingList(Of Asistencia)

  Public Function ListaSeleccionadas() As AsistenciaList
    Dim _Asistencias As New AsistenciaList
    For Each _Asistencia As Asistencia In Me
      If _Asistencia.Seleccionado Then
        _Asistencias.Add(_Asistencia)
      End If
    Next
    Return _Asistencias
  End Function

  'Public Function ListaEmpleadosSeleccionados() As EmpleadoList
  '  Dim _empleados As New EmpleadoList
  '  For Each _contrato As Contrato In Me
  '    If _contrato.Seleccionado Then
  '      _empleados.Add(_contrato.Empleado)
  '    End If
  '  Next
  '  Return _empleados
  'End Function

  Public Shared Function ObtenerLista(ByVal _OperadorDatos As OperadorDatos, Optional ByVal _filtro As String = "") As AsistenciaList
    Dim oResult As AsistenciaList = New AsistenciaList
    Dim bReturn As Boolean
    Dim ds As DataTable = Nothing
    With _OperadorDatos
      .AgregarParametro("@Accion", "F")
      .AgregarParametro("@filtro", _filtro)
      .Procedimiento = "proc_Asistencia"
      bReturn = .Ejecutar(ds)
      .LimpiarParametros()
    End With
    If bReturn AndAlso ds IsNot Nothing AndAlso ds.Rows.Count > 0 Then
      For Each _dr As DataRow In ds.Rows
        Dim _fila As New Asistencia(_OperadorDatos, False)
        _fila.MapearDataRowaObjeto(_dr)
        oResult.Add(_fila)
      Next
    End If
    Return oResult
  End Function

  Public Shared Function RetornarAsistenciasPeriodo(ByVal _OperadorDatos As OperadorDatos, ByVal _patrono As Patrono, ByVal _Tipocontrato As TipoContrato, ByVal _periodo As PeriodoPago, ByVal _diassingrabar As Boolean) As AsistenciaList
    Dim oResult As New AsistenciaList
    Dim bReturn As Boolean
    Dim dsResult As New DataTable
    With _OperadorDatos
      .AgregarParametro("@accion", "rp")
      .AgregarParametro("@Patron_Codigo", _patrono.Patron_Codigo)
      If _Tipocontrato IsNot Nothing Then
        .AgregarParametro("@TipCon_Codigo", _Tipocontrato.TipCon_Codigo)
      End If
      .AgregarParametro("@PerPag_FechaDesde", _periodo.PerPag_FechaDesde)
      .AgregarParametro("@Parame_PeriodoPago", _periodo.Parame_PeriodoPago)
      .AgregarParametro("@Pardet_PeriodoPago", _periodo.Pardet_PeriodoPago)
      If _diassingrabar Then
        .AgregarParametro("@diassingrabar", _diassingrabar)
      End If
      .Procedimiento = "proc_Asistencia"
      bReturn = .Ejecutar(dsResult)
      .LimpiarParametros()
    End With
    If bReturn AndAlso dsResult IsNot Nothing AndAlso dsResult.Rows.Count > 0 Then
      For Each _dr As DataRow In dsResult.Rows
        Dim _obj As New Asistencia(_OperadorDatos, False)
        _obj.MapearDataRowaObjeto(_dr)
        oResult.Add(_obj)
      Next
    End If
    Return oResult
  End Function

  Public Enum enumTipolistadofirmas
    Todos = 0
    Seccion = 1
    Sexo = 2
  End Enum

  Public Shared Function RetornarListadoFirma(ByVal _OperadorDatos As OperadorDatos, ByVal _tiporeporte As enumTipolistadofirmas, ByVal _tipocontrato As TipoContrato, ByVal _periodo As PeriodoPago, ByVal _patrono As Patrono, ByVal _clase As WWTSParametroDet, ByVal _seccion As WWTSParametroDet, ByVal _sexo As String, ByVal _nomostrarcerosnetos As Boolean, ByVal _nomostrarninguncero As Boolean) As AsistenciaList
    Dim oResult As New AsistenciaList
    Dim bReturn As Boolean = True
    Dim dsResult As New DataTable
    With _OperadorDatos
      .AgregarParametro("@accion", "lis")
      .AgregarParametro("@esdestajo", _tipocontrato.Pardet_TipoContratoEnum = Enumerados.enumTipoContrato.Destajo)
      Select Case _tiporeporte
        Case enumTipolistadofirmas.Seccion
          .AgregarParametro("@Parame_Seccion", _seccion.Parame_Codigo)
          .AgregarParametro("@Pardet_Seccion", _seccion.Pardet_Secuencia)
        Case enumTipolistadofirmas.Sexo
          .AgregarParametro("@sexo", _sexo)
      End Select
      If Not _clase Is Nothing Then
        .AgregarParametro("@Parame_Clase", _clase.Parame_Codigo)
        .AgregarParametro("@Pardet_Clase", _clase.Pardet_Secuencia)
      End If
      .AgregarParametro("@Patron_Codigo", _patrono.Patron_Codigo)
      .AgregarParametro("@TipCon_Codigo", _tipocontrato.TipCon_Codigo)
      .AgregarParametro("@PerPag_FechaDesde", _periodo.PerPag_FechaDesde)
      .AgregarParametro("@Parame_PeriodoPago", _periodo.Parame_PeriodoPago)
      .AgregarParametro("@Pardet_PeriodoPago", _periodo.Pardet_PeriodoPago)
      .AgregarParametro("@nomostrarcerosnetos", _nomostrarcerosnetos)
      .AgregarParametro("@nomostrarninguncero", _nomostrarninguncero)
      .Procedimiento = "proc_Asistencia"
      bReturn = .Ejecutar(dsResult)
      .LimpiarParametros()
    End With
    If bReturn AndAlso dsResult IsNot Nothing AndAlso dsResult.Rows.Count > 0 Then
      For Each _dr As DataRow In dsResult.Rows
        Dim _obj As New Asistencia(_OperadorDatos, False)
        _obj.MapearDataRowaObjeto(_dr)
        oResult.Add(_obj)
      Next
    End If
    Return oResult
  End Function

  Public Shared Function RetornarSueldosLiquidacion(ByVal _OperadorDatos As OperadorDatos, ByVal _contrato As Contrato) As AsistenciaList
    Dim oResult As New AsistenciaList
    Dim bReturn As Boolean = True
    Dim dsResult As New DataTable
    With _OperadorDatos
      .AgregarParametro("@accion", "pdt")
      .AgregarParametro("@Patron_Codigo", _contrato.Patron_Codigo)
      .AgregarParametro("@Contra_Secuencia", _contrato.Contra_Secuencia)
      .AgregarParametro("@Entida_Codigo", _contrato.Entida_Codigo)
      .Procedimiento = "proc_Asistencia"
      bReturn = .Ejecutar(dsResult)
      .LimpiarParametros()
    End With
    If bReturn AndAlso dsResult IsNot Nothing AndAlso dsResult.Rows.Count > 0 Then
      For Each _dr As DataRow In dsResult.Rows
        Dim _obj As New Asistencia(_OperadorDatos, False)
        _obj.MapearDataRowaObjeto(_dr)
        oResult.Add(_obj)
      Next
    End If
    Return oResult
  End Function

  Public Shared Function ObtenerAsistencia(ByVal _OperadorDatos As OperadorDatos, ByVal _Contrato As Contrato, ByVal _PeriodoPago As PeriodoPago, Optional ByVal _filtro As String = "") As AsistenciaList
    Dim oResult As AsistenciaList = New AsistenciaList
    Dim bReturn As Boolean
    Dim ds As DataTable = Nothing
    With _OperadorDatos
      .AgregarParametro("@accion", "FA")
      .AgregarParametro("@Entida_Codigo", _Contrato.Entida_Codigo)
      .AgregarParametro("@Patron_Codigo", _Contrato.Patron_Codigo)
      .AgregarParametro("@PerPag_FechaDesde", _PeriodoPago.PerPag_FechaDesde)
      .AgregarParametro("@Parame_PeriodoPago", _PeriodoPago.Parame_PeriodoPago)
      .AgregarParametro("@Pardet_PeriodoPago", _PeriodoPago.Pardet_PeriodoPago)
      .AgregarParametro("@filtro", _filtro)
      .Procedimiento = "proc_Asistencia"
      bReturn = .Ejecutar(ds)
      .LimpiarParametros()
    End With
    If bReturn AndAlso ds IsNot Nothing AndAlso ds.Rows.Count > 0 Then
      For Each _dr As DataRow In ds.Rows
        Dim _fila As New Asistencia(_OperadorDatos, False)
        _fila.MapearDataRowaObjeto(_dr)
        oResult.Add(_fila)
      Next
    End If
    Return oResult
  End Function
End Class
#End Region
